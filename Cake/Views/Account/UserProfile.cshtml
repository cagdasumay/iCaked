@using System.Data
@using Cake.Controllers

@{
    Layout = "/Views/Shared/_Layout.cshtml";

    DatabaseController dc = new DatabaseController();
    UtilityController uc = new UtilityController();

    bool profileExists = true;

    if (ViewData["profileExists"] != null)
    {
        if ((bool)ViewData["profileExists"] == false) { profileExists = false; } else { profileExists = true; }
    }

    DataRow user = (DataRow)ViewData["userinfo"];
    String userName = uc.UppercaseFirst(user["Name"].ToString()); String userSurname = uc.UppercaseFirst(user["Surname"].ToString());
    ViewBag.Title = "Cake Boss " + userName + " " + userSurname + " Profile";
    ViewBag.Keywords = "Tasarım Pasta, Butik Pasta Siparişi," + userName + " " + userSurname + ", Özel Tasarım, Özel Tasarım Pasta, Ürünler";
    ViewBag.description = "You can order from pastes made by " + userName + " " + userSurname + "Everyone is now a boutique cake designer with iCaked.";
}

<script type="text/javascript" src="~/scripts/UtilityScripts/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="~/Content/jquery.dataTables.min.css" />

<script type="text/javascript">

    $(document).ready(function () {
        $("#profile-orders-table").DataTable({
            "order": [[0, "desc"]],
            responsive: true
        });

        $("#userCakes,#profile-favs-slider").owlCarousel({
            items: 5,
            itemsTablet: [600, 3],
            itemsMobile: [479, 2],
            pagination: true,
            navigation: true,
            navigationText: [
  "<img src='/Images/Site/nav_left.png'  style='width:30px; box-shadow:none !important; border:none !important; background:none !important;' />",
  "<img src='/Images/Site/nav_right.png' style='width:30px; box-shadow:none !important; border:none !important; background:none !important;' />",
            ],
        });
    });
</script>

<div class="container" style="margin-bottom:100px;">
    @{
        if (profileExists)
        {
            string whoseProfileIsThis = (string)ViewData["whoseProfileIsThis"];
            string whois = (string)ViewData["whatIsThePermission"];

            if (whoseProfileIsThis == "admin" & whois == "own")
            {
                ViewBag.Title = "Admin Panel";
                @Html.Partial("AdminPanel", ViewData);
            }
            else
            {
                List<DataRow> favedProducts = (List<DataRow>)ViewData["favedProducts"];
                List<DataRow> favedDesigns = (List<DataRow>)ViewData["favedDesigns"];

                String[] cities = new String[] { "Adana", "Adiyaman", "Afyonkarahisar", "Ağri", "Aksaray", "Amasya", "Ankara", "Antalya", "Ardahan", "Artvin", "Aydin", "Balikesir", "Bartin", "Batman", "Bayburt", "Bilecik", "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankiri", "Çorum", "Denizli", "Diyarbakir", "Düzce", "Edirne", "Elaziğ", "Erzincan", "Erzurum", "Eskişehir", "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdir", "Isparta", "İstanbul(asya)", "İstanbul(avr)", "İzmir", "Kahramanmaraş", "Karabük", "Karaman", "Kars", "Kastamonu", "Kayseri", "Kilis", "Kirikkale", "Kirklareli", "Kirşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa", "Mardin", "Mersin", "Muğla", "Muş", "Nevşehir", "Niğde", "Ordu", "Osmaniye", "Rize", "Sakarya", "Samsun", "Şanliurfa", "Siirt", "Sinop", "Şirnak", "Sivas", "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Uşak ", "Van", "Yalova", "Yozgat", "Zonguldak" };
                String[] cityIds = new String[] { "81", "80", "79", "78", "14", "77", "76", "75", "7", "74", "73", "72", "8", "10", "13", "71", "70", "69", "68", "67", "66", "65", "64", "63", "62", "61", "1", "60", "59", "58", "57", "56", "55", "54", "53", "52", "51", "6", "50", "83", "48", "47", "36", "4", "12", "46", "45", "44", "3", "11", "43", "42", "41", "40", "39", "38", "37", "35", "49", "34", "33", "32", "31", "30", "2", "29", "28", "27", "19", "26", "25", "9", "24", "23", "22", "21", "20", "18", "17", "5", "16", "15", };

                DataTable cakes = new DataTable();

                if (whois == "own" | whois == "admin")
                {
                    cakes = dc.DBQueryGetter("select * from MadeCakes where UserID = '" + user["UserID"] + "'");
                }
                else
                {
                    cakes = dc.DBQueryGetter("select * from MadeCakes where UserID = '" + user["UserID"] + "' and Visible = 'yes'");
                }

                if (cakes.Rows.Count > 0)
                {
                    DataView dv = cakes.DefaultView;
                    dv.Sort = "DateTime desc";
                    cakes = dv.ToTable();
                }

                DataTable bakeries = dc.DBQueryGetter("select * from ForeignBakeries");

                bool followExists = false;

                if (Session["userinfo"] != null) { followExists = dc.DBQueryGetter("select * from Follows where UserID = '" + user["UserID"] + "' and FollowerID = '" + ((DataRow)Session["userinfo"])["UserID"] + "'").Rows.Count > 0; }

                if (whois == "own" | whois == "admin")
                {
                <div class="row" style="padding:0px 15px; padding-right:15px; margin-top:30px;">

                    <nav class="navbar navbar-default" style="background:none; margin-bottom:0px;">
                        <div class="container-fluid">
                            <div class="navbar-header">
                                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#profileNavbar" aria-expanded="false">
                                    <span class="sr-only">Toggle navigation</span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                    <span class="icon-bar"></span>
                                </button>
                            </div>
                            <div class="collapse navbar-collapse" id="profileNavbar" style="padding:0px; background:white;">
                                <ul class="nav navbar-nav">
                                    <li id="profile-link" class="block-wrapper active-bakery" style="height:68px; padding-bottom:7px; border-top-left-radius:5px; border-bottom-left-radius:5px;" onclick="toggleProfileDivs(this.id,'profile')">
                                        <img alt="profil sekmesi" src="~/Images/Site/user_icon_gray.png" />
                                        <label>Profile</label>
                                    </li>
                                    <li id="order-link" class="block-wrapper" style="height:68px; padding-bottom:7px;" onclick="toggleProfileDivs(this.id,'order')">
                                        <img alt="siparişler sekmesi" src="~/Images/Site/delivery_icon_gray.png" />
                                        <label>Orders</label>
                                    </li>
                                    <li id="info-link" class="block-wrapper" style="height:68px; padding-bottom:7px;" onclick="toggleProfileDivs(this.id,'info')">
                                        <img alt="bilgiler sekmesi" src="~/Images/Site/edit_icon_gray.png" />
                                        <label>Info</label>
                                    </li>
                                    <li id="follow-link" class="block-wrapper" style="height:68px; padding-bottom:7px;" onclick="toggleProfileDivs(this.id,'follow')">
                                        <img alt="takip sekmesi" src="~/Images/Site/follow_icon.png" />
                                        <label>Follow</label>
                                    </li>
                                    <li id="address-link" class="block-wrapper" style="height:68px; padding-bottom:7px;" onclick="toggleProfileDivs(this.id,'address')">
                                        <img alt="adres sekmesi" src="~/Images/Site/location_icon.png" style="margin-top:3px;" />
                                        <label>Addresses</label>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </nav>
                </div>
                }

            <div class="row" id="profile-wrapper" style="margin:2% 0px;">

                <div class="col-md-12 col-sm-12 col-xs-12" id="profile-left-wrapper">

                        <div class="col-md-12 col-sm-12 col-xs-12" style="border-bottom:1px solid #e6e6e6; padding:0px; margin-bottom:10px; float:left; background:white;">
                            @{
                                if (Session["userinfo"] != null & !followExists & whois != "own" & whois != "admin")
                                {
                                    <img alt="kullanıcı takip et" onclick="followUser('@user["UserID"]')" src="~/Images/Site/add_icon.png" style="width:20px; position:absolute; right:20px; top:20px; cursor:pointer;" />
                                }

                                if (followExists)
                                {
                                    <img alt="kullanıcı takip etmeyi bırak" onclick="stopFollowingUser('@user["UserID"]')" src="~/Images/Site/remove_icon.png" style="width:20px; position:absolute; right:20px; top:20px; cursor:pointer;" />
                                }
                            }
                            <div style="float:left;">

                                @{
                                    if (String.IsNullOrEmpty(user["Thumbnail"].ToString()) == false)
                                    {
                                        String thumbnail = "/Images/Users/" + user["Thumbnail"];
                                        <img alt="profil resmi" class="profile-thumbnail" src="@thumbnail" />
                                    }
                                    else
                                    {
                                        <img alt="örnek profil resmi" class="profile-thumbnail" src="~/Images/Users/default_thumbnail.png" />
                                    }

                                    String name = user["Name"].ToString().Substring(0, 1).ToUpper() + user["Name"].ToString().Substring(1, user["Name"].ToString().Length - 1);
                                    String surname = user["Surname"].ToString().Substring(0, 1).ToUpper() + user["Surname"].ToString().Substring(1, user["Surname"].ToString().Length - 1);
                                }
                                <h1 style="font-size:30px; line-height:75px; color:#2f2f2f; font-weight:500; margin-left:20px; float:left; text-align:center;">@name @surname</h1>
                            </div>

                            <div style="float:right;">
                                <div style="float:right; margin-left:10px; padding:10px; border:1px solid #e6e6e6; border-radius:20px;">
                                    <img alt="tasarladığı pasta sayısı" src="~/Images/Site/editor_cake_icon_brown.png" style="width:20px; margin-right:5px;" />
                                    <label style="font-size:16px; vertical-align:middle; font-family:'Open Sans';">@cakes.Rows.Count</label>
                                </div>
                                <div style="float:right; margin-left:10px; padding:10px; border:1px solid #e6e6e6; border-radius:20px;">
                                    <img alt="takipçi sayısı" src="~/Images/Site/user_2.png" style="width:10px; margin-right:5px;" />
                                    <label style="font-size:16px;  vertical-align:middle; font-family:'Open Sans';">@user["Followers"]</label>
                                </div>
                                <div style="float:right; padding:10px; border:1px solid #e6e6e6; border-radius:20px;">
                                    <img alt="beğenilen ürün sayısı" src="~/Images/Site/heart_icon_filled_brown.png" style="width:15px; margin-right:5px;" />
                                    <label style="font-size:16px;  vertical-align:middle; font-family:'Open Sans';">@favedProducts.Count</label>
                                </div>
                            </div>
                            <div style="float:left; width:100%;">
                                @using (Html.BeginForm("ChangeUserImage", "Account", FormMethod.Post, new { enctype = "multipart/form-data", id = "changeUserImgForm" }))
                                {


                                    if (whois == "own" | whois == "admin")
                                    {
                                        <input onchange="$('#changeUserImgForm').submit()" type="file" id="upload_userImg" name="upload_userImg" style="display:none;" />
                                        <div style="margin-top:10px; width:100%; float:left;">
                                            <div style="padding-left:0px; float:left; padding-right:5px;">
                                                <img onclick="$('#upload_userImg').trigger('click')" src="~/Images/Site/edit_icon_gray.png" style="width:25px; border-radius:50%; cursor:pointer; border:1px solid #ccc; padding:3px; position:absolute; top:0px; background:white;" />
                                            </div>
                                        </div>
                                    }

                                }
                            </div>
                        </div>

                </div>

                <div class="col-md-12 col-sm-12 col-xs-12" id="profile-right-wrapper">
                    <div class="col-md-12 col-sm-12 col-xs-12" id="profile-right-upper-wrapper">
                        <div class="profile-header-div">
                            <div id="userCakes" class="owl-carousel design-product" style="width:100%; float:left;">
                                @{
                                    for (int i = 0; i < cakes.Rows.Count; i++)
                                    {
                                        DataRow design = cakes.Rows[i];
                                        String img = "/Images/MadeCakes/" + design["MadeID"] + "/designImg-275x275.png";

                                        String designType = uc.cleanseUrlString(design["Type"].ToString().Replace("\r\n", ""));
                                        String designName = uc.cleanseUrlString(design["Name"].ToString()) + "-" + design["MadeID"].ToString().Split('-')[0];
                                        String price = uc.ArrangePrice(design["PriceInterval"].ToString());

                                        <div class="col-md-12 col-sm-12 col-xs-12 item" style="padding:1.5%; float:left;">
                                            <a  href="@Url.Action("Tasarim", "Home", new { type = designType, designName = designName })">
                                                <div class="new-product-wrapper" style="padding:1%;">
                                                    <img class="new-product-img" alt="ürün tasarım pasta" src="@img" onclick="$(this).parent().parent().submit()" />
                                                    <div class="new-product-div">
                                                        <span class="new-product-name">@design["Name"]</span>
                                                        <span class="new-product-description">@design["SizeOptions"] kişilik</span>
                                                        <span class="new-product-price"> @price.Split('.')[0] <span style="font-size:16px; margin-left:-7px;">.@price.Split('.')[1] TL</span></span>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12" id="profile-right-lower-wrapper">
                        <div class="profile-header-div">
                            <div id="profile-favs-slider" class="owl-carousel" style="width:100%; float:left;">
                                @{
                                    for (int i = 0; i < favedProducts.Count; i++)
                                    {
                                        DataRow urun = favedProducts[i];
                                        String product_thumbnail = "/Images/Products/" + urun["ProductID"] + "/" + (urun["Thumbnail"].ToString().Split(' '))[0];
                                        String price = urun["Price"].ToString().Split(' ')[0];
                                        price = uc.ArrangePrice(price);

                                        String productCategory = uc.cleanseUrlString(urun["Category"].ToString());
                                        String productBakery = uc.cleanseUrlString(dc.getBakeryNameByID(new Guid(urun["BakeryID"].ToString())));
                                        String productName = uc.cleanseUrlString(urun["Name"].ToString()) + "-" + urun["ProductID"].ToString().Split('-')[0];

                                        <div class="item col-md-12 col-sm-12 col-xs-12 sortFilterBakeryProduct" style="padding:0.5%;">
                                            <a  href="@Url.Action("Product", "Bakery", new { category = productCategory, bakeryName = productBakery, productName = productName })">
                                                <div class="new-product-wrapper" style="padding:1%; width:100%; float:left;">
                                                    <img class="new-product-img" alt="ürün tasarım pasta" src="@product_thumbnail" onclick="$(this).parent().parent().submit()" />
                                                    <div class="new-product-div">
                                                        <span class="new-product-name">@urun["Name"]</span>
                                                        <div class="new-product-rating" data-rating="@urun["rating"]" style="float:left; pointer-events:none; width:100%; padding-bottom:8px;"></div>
                                                        <span class="new-product-description2">@uc.productCatCorrector(urun)</span>
                                                        <span class="new-product-price"> @price.Split('.')[0] <span style="font-size:16px; margin-left:-7px;">.@price.Split('.')[1] TL</span></span>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>

                @{
                    if (whois == "own" | whois == "admin")
                    {
                        <div class="col-md-12 col-sm-12 col-xs-12" style="border:2px solid #f0f0f0; height:500px; display:none; float:left; background:white;" id="info-wrapper">
                            <label style="float:left; font-size:20px; padding:15px 0px; width:100%; border-bottom:1px solid #3f2518; margin-bottom:10px !important; color:#3f2518;">My Info</label>
                            <div class="col-md-2 col-sm-3 col-xs-5" id="info-change-label-div">
                                <label>Name : </label>
                                <label>Surname : </label>
                                <label>Birth Date : </label>
                                @*<label>Cinsiyet : </label>*@
                                <label>E-Mail : </label>
                                <label>Password : </label>
                            </div>

                            <div class="col-md-4 col-sm-9 col-xs-7" style="padding:0px;">

                                <div id="name-change-div" data-change="name" class="info-change-input-div">
                                    @{
                                        if (String.IsNullOrEmpty(user["Email"].ToString()))
                                        { <label>Click to Change</label> }
                                        else
                                        { <label>@user["Name"]</label> }
                                    }
                                    <img alt="isim değiştir" src="~/Images/Site/edit_icon.png" />
                                    <div class="profile-info-edit-div">
                                        <input type="text" placeholder="Name" />
                                        <button class="ok-btn yukle_gradient">✓</button> <button class="cancel-btn yukle_gradient">✗</button>
                                    </div>
                                </div>

                                <div id="surname-change-div" data-change="surname" class="info-change-input-div">
                                    @{
                                        if (String.IsNullOrEmpty(user["Email"].ToString()))
                                        { <label>Click to Change</label> }
                                        else
                                        { <label>@user["Surname"]</label> }
                                    }
                                    <img alt="soyadı değiştir" src="~/Images/Site/edit_icon.png" />
                                    <div class="profile-info-edit-div">
                                        <input type="text" placeholder="Surname" />
                                        <button class="ok-btn yukle_gradient">✓</button> <button class="cancel-btn yukle_gradient">✗</button>
                                    </div>
                                </div>

                                <div id="birth-change-div" data-change="birth" class="info-change-input-div">
                                    @{
                                        if (String.IsNullOrEmpty(user["Birth"].ToString()))
                                        { <label>Click to Change</label> }
                                        else
                                        { <label>@Convert.ToDateTime(user["Birth"]).Date.ToString("dd.MM.yyyy")</label> }
                                    }
                                    <img alt="doğum tarihi değiştir" src="~/Images/Site/edit_icon.png" />
                                    <div class="profile-info-edit-div">
                                        <input readonly style="min-width:125px;" id="profile-info-birth" type="text" placeholder="Birth Date" />
                                        <button class="ok-btn yukle_gradient">✓</button> <button class="cancel-btn yukle_gradient">✗</button>
                                    </div>
                                </div>

                                <div id="email-change-div" data-change="email" class="info-change-input-div">
                                    @{
                                        if (String.IsNullOrEmpty(user["Email"].ToString()))
                                        { <label>Click to Change</label> }
                                        else
                                        { <label>@user["Email"]</label> }
                                    }
                                    <img alt="eposta değiştir" src="~/Images/Site/edit_icon.png" />
                                    <div class="profile-info-edit-div">
                                        <input type="text" placeholder="E-Mail" />
                                        <button class="ok-btn yukle_gradient">✓</button> <button class="cancel-btn yukle_gradient">✗</button>
                                    </div>
                                </div>

                                <div id="password-change-div" data-change="password" class="info-change-input-div">
                                    <label>Click to Change</label>
                                    <img alt="şifre değiştir" src="~/Images/Site/edit_icon.png" />
                                    <div class="profile-info-edit-div" id="password-change-sub-div">
                                        <div style="float:left; width:128px; text-align:left;">
                                            <input type="text" id="old-pass" class="password-input" placeholder="Old Password" />
                                            <input type="password" id="new-pass" class="password-input" placeholder="New Password" />
                                            <input type="password" id="new-pass-confirm" class="password-input" placeholder="New Password Again" />
                                        </div>

                                        <div style="float:left; width:100%; text-align:left;">
                                            <button class="ok-btn yukle_gradient" style="margin-left:0px;">✓</button> <button id="password-cancel" class="cancel-btn yukle_gradient">✗</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="width:100%; float:left; padding-top:130px;">
                                <a onclick="DeleteAccount()" href="@Url.Action("DeleteAccount","Account")" class="white-gradient" style="float:right;">Delete Account</a>
                            </div>

                        </div>

                        <div class="col-md-12 col-sm-12 col-xs-12" style="border:2px solid #f0f0f0; padding-bottom:15px; display:none; float:left; background:white;" id="order-wrapper">
                            @Html.Partial("_ProfileOrders")
                        </div>

                        <div class="col-md-12 col-sm-12 col-xs-12" style="border:2px solid #f0f0f0; max-height:500px; height:500px; display:none; float:left; background:white;" id="follow-wrapper">
                            @Html.Partial("_ProfileFollowers")
                        </div>

                        <div class="col-md-12 col-sm-12 col-xs-12" style="border:2px solid #f0f0f0; min-height:500px; display:none; float:left; background:white;" id="address-wrapper">
                            @Html.Partial("_ProfileAddress")
                        </div>
                                        }
                }

            </div>
                                                    }
                                                }
                                                else
                                                {
                                                    ViewBag.Title = "Profile Not Found";
            <div style="width:100%; float:left; text-align:center;">
                <img src="~/Images/Site/sapka_icon.png" style="width:50px; margin-bottom:30px; margin-top:150px; -webkit-filter: drop-shadow(1px 3px 1px #cccccc);" />
            </div>
                    <div style="width:100%; float:left; height:300px; text-align:center;">
                        <label style="font-size:18px; font-weight:400;">Profile Not Found.</label>
                        <a style="font-size:18px; color:black !important; font-weight:400;" href="@Url.Action("Editor","Home")">Let's take you to the <b>editor</b></a>
                    </div>
            }
                                            }
</div>